<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->

<ng-container *transloco="let t; read: 'calculationResult'">
  <mat-accordion [multi]="true">
    <!-- Section for the grease result section -->

    <div class="pb-4">
      @if (hasMiscibileGreases()) {
        <ga-selected-competitor-grease
          class="flex flex-row gap-4 items-center pb-4"
        ></ga-selected-competitor-grease>
      }

      @if (hasMessages$ | ngrxPush) {
        @for (entry of resultMessages$ | ngrxPush; let i = $index; track i) {
          <div
            class="mx-3 flex items-center text-on-warning-container min-w-0 flex-row gap-4 justify-between rounded border border-warning bg-warning-container p-3 lg:m-0 lg:mb-3"
          >
            <div class="text-body-small font-normal text-on-warning-container">
              {{ entry.text }}
            </div>
            <div>
              @for (link of entry.links; let k = $index; track k) {
                <a [href]="link.url" mat-flat-button>
                  <mat-icon>open_in_new</mat-icon>
                  {{ link.text }}
                </a>
              }
            </div>
          </div>
        }
      }

      @if (concept1Impossible()) {
        <div
          class="mx-3 flex min-w-0 flex-row gap-4 rounded border border-warning bg-warning-container p-3 lg:m-0 lg:mb-3"
          [ngClass]="{ '!mb-6': greaseResultAmount() <= resultsLimit }"
        >
          <div class="text-body-small font-normal text-on-warning-container">
            {{ t('concept1Impossible') }}
          </div>
        </div>
      }

      <div
        class="grid lg:grid-cols-3 md:grid-cols-2 grid-cols-1 gap-8 grid-flow-row"
      >
        @for (greaseResult of greaseResults() || []; track greaseResult) {
          <div class="col-span-1">
            <ga-grease-report-result-card
              [greaseResult]="greaseResult"
              [preferredGreaseResult]="preferredGreaseResult()"
              [automaticLubrication]="automaticLubrication()"
              [selectionModeEnabled]="greasePDFSelection.selectionMode()"
              [greaseSelected]="
                greasePDFSelection.selectedSet().has(greaseResult.mainTitle)
              "
              (toggleSelection)="handleGreaseToggle($event)"
            ></ga-grease-report-result-card>
          </div>
        }
      </div>

      @if (greaseResultAmount() > resultsLimit) {
        <!-- Section for the result cards only -->
        <div class="flex flex-row justify-center pt-6">
          <button
            class="w-full self-center !py-2 md:!w-auto"
            mat-button
            (click)="limitResults.set(!limitResults())"
          >
            <div class="flex flex-col items-center">
              @if (!limitResults()) {
                <mat-icon class="text-medium-emphasis">expand_less</mat-icon>
              }
              <span class="leading-4 text-medium-emphasis">{{
                t(limitResults() ? 'remainingResults' : 'limitResults', {
                  results: limitResults()
                    ? greaseResultAmount() - greaseResults().length
                    : resultsLimit,
                })
              }}</span>
              @if (limitResults()) {
                <mat-icon class="text-medium-emphasis">expand_more</mat-icon>
              }
            </div>
          </button>
        </div>
      }
      <div class="p-3">
        <span class="text-body-small">{{ t('guideValues') }}</span>
      </div>
      @if (hasMiscibileGreases()) {
        <ga-grease-disclaimer></ga-grease-disclaimer>
      }
    </div>

    <!-- Section for the warnings errors and notes section -->
    @if (errorWarningsAndNotes()) {
      <mat-expansion-panel [expanded]="errorWarningsAndNotes()?.defaultOpen">
        <mat-expansion-panel-header
          (click)="
            !errorWarningsAndNotes()?.defaultOpen &&
              !!errorWarningsAndNotes().clickHandler &&
              errorWarningsAndNotes().clickHandler()
          "
          (keydown)="
            !errorWarningsAndNotes()?.defaultOpen &&
              !!errorWarningsAndNotes().clickHandler &&
              errorWarningsAndNotes().clickHandler()
          "
        >
          <mat-panel-title class="w-full">
            <span>{{ errorWarningsAndNotes()?.title }}</span>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div class="pb-4">
          @if (hasMessages$ | ngrxPush) {
            @for (
              entry of resultMessages$ | ngrxPush;
              let i = $index;
              track i
            ) {
              <div
                class="mx-3 flex items-center text-on-warning-container min-w-0 flex-row gap-4 justify-between rounded border border-warning bg-warning-container p-3 lg:m-0 lg:mb-3"
              >
                <div
                  class="text-body-small font-normal text-on-warning-container"
                >
                  {{ entry.text }}
                </div>
                <div>
                  @for (link of entry.links; let k = $index; track k) {
                    <a [href]="link.url" mat-flat-button>
                      <mat-icon>open_in_new</mat-icon>
                      {{ link.text }}
                    </a>
                  }
                </div>
              </div>
            }
          }

          <div>
            @for (
              subordinate of errorWarningsAndNotes()?.subordinates || [];
              let index = $index;
              track subordinate
            ) {
              <ng-template
                [ngTemplateOutlet]="subordinateTemplate"
                [ngTemplateOutletContext]="{
                  subordinate: subordinate,
                  displayTitle: false,
                  index: index,
                }"
              >
              </ng-template>
            }
          </div>
        </div>
      </mat-expansion-panel>
    }
    <!-- Section for the input section -->
    @if (greaseInput()) {
      <mat-expansion-panel>
        <mat-expansion-panel-header
          (click)="logTogglingInputSection()"
          (keydown)="logTogglingInputSection()"
        >
          {{ t('reportSectionInput') }}
        </mat-expansion-panel-header>
        <ga-grease-report-input
          [greaseReportInput]="greaseInput()"
        ></ga-grease-report-input>
      </mat-expansion-panel>
    }
  </mat-accordion>
</ng-container>

<!-- custom content -->
<ng-content></ng-content>

<!-- subordinate display -->
<ng-template
  #subordinateTemplate
  let-subordinate="subordinate"
  let-displayTitle="displayTitle"
  let-index="index"
>
  <!-- check for existence of subordinate and make it typed -->
  @if (typedSubordinate(subordinate); as subordinate) {
    <!-- text -->
    @if (subordinate.identifier === 'text' && subordinate.text?.length) {
      @for (paragraph of subordinate.text; track paragraph) {
        <p class="whitespace-pre-wrap">{{ paragraph }}</p>
      }
    }
    <!-- legalNote -->
    @if (subordinate.identifier === 'legalNote' && subordinate.legal) {
      <p>{{ subordinate.legal }}</p>
    }
    <!-- block -->
    @if (
      subordinate.identifier === 'block' && displayTitle && subordinate?.title
    ) {
      <h5 class="pt-4 pb-2">{{ subordinate?.title }}</h5>
    }
    <!-- variableBlock-->
    @if (subordinate.identifier === 'variableBlock') {
      <h6 class="pt-4 pb-2">{{ subordinate?.title }}</h6>
    }
    <!-- recursive nested subordinates -->
    @if (subordinate?.subordinates) {
      @for (
        nestedSubordinate of subordinate?.subordinates || [];
        let index2 = $index;
        track nestedSubordinate
      ) {
        <ng-container
          [ngTemplateOutlet]="subordinateTemplate"
          [ngTemplateOutletContext]="{
            subordinate: nestedSubordinate,
            displayTitle: true,
            index: index2,
          }"
        >
        </ng-container>
      }
    }
  }
  @if (subordinate.titleID === messageSectionId && versions()) {
    <div *transloco="let t; read: 'calculationResult'">
      <span class="text-body-small">{{
        t('calculatedWith', { versions: versions() })
      }}</span>
    </div>
  }
</ng-template>

@if (isAppEmbedded$ | ngrxPush) {
  <ga-app-store-buttons
    class="flex justify-center mb-8"
    [title]="'shared.appStoreButtonsTitle' | transloco"
  ></ga-app-store-buttons>
}

<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<mat-accordion [multi]="true" *transloco="let t; read: 'calculationResult'">
  @if (greaseInput) {
    <mat-expansion-panel>
      <mat-expansion-panel-header (click)="logTogglingInputSection()">
        {{ t('reportSectionInput') }}
      </mat-expansion-panel-header>
      <ga-grease-report-input
        [greaseReportInput]="greaseInput"
      ></ga-grease-report-input>
    </mat-expansion-panel>
  }
  @for (subordinate of subordinates; track subordinate) {
    @if (!isInputSection(subordinate)) {
      <mat-expansion-panel
        [expanded]="subordinate.defaultOpen"
        [disabled]="isGreaseResultSection(subordinate.titleID)"
      >
        <mat-expansion-panel-header
          [ngClass]="{
            '!cursor-default !text-high-emphasis': isGreaseResultSection(
              subordinate.titleID
            )
          }"
          (click)="
            !subordinate.defaultOpen &&
              !!subordinate.clickHandler &&
              subordinate.clickHandler()
          "
        >
          <mat-panel-title class="w-full">
            @if (isGreaseResultSection(subordinate.titleID)) {
              <span class="truncate">
                {{
                  t(
                    preferredGreaseResult?.id
                      ? 'resultsWithPreferred'
                      : 'resultsDefault',
                    {
                      amount: limitResults ? resultsLimit : getResultAmount(),
                      complete: getResultAmount()
                    }
                  )
                }}
              </span>
            } @else {
              <span>{{ subordinate.title }}</span>
            }
          </mat-panel-title>
        </mat-expansion-panel-header>
        <div
          class="pb-4 lg:px-6"
          [ngClass]="
            isGreaseResultSection(subordinate.titleID) ? 'px-0' : 'px-4'
          "
        >
          @if (
            isGreaseResultSection(subordinate.titleID) && concept1Impossible()
          ) {
            <div
              class="mx-3 flex min-w-0 flex-row gap-4 rounded border border-warning bg-warning p-3 lg:m-0 lg:mb-3"
              [ngClass]="{ '!mb-6': getResultAmount() <= resultsLimit }"
            >
              <div class="text-caption font-normal text-warning">
                {{ t('concept1Impossible') }}
              </div>
            </div>
          }
          <div>
            <ng-template
              [ngTemplateOutlet]="subordinateTemplate"
              [ngTemplateOutletContext]="{
                subordinate: subordinate,
                displayTitle: false
              }"
            >
            </ng-template>
          </div>
          @if (
            isGreaseResultSection(subordinate.titleID) &&
            getResultAmount() > resultsLimit
          ) {
            <div class="flex flex-row justify-center">
              <button
                class="w-full self-center !py-2 md:!w-auto"
                mat-button
                (click)="toggleLimitResults()"
              >
                <div class="flex flex-col items-center">
                  @if (!limitResults) {
                    <mat-icon class="text-medium-emphasis"
                      >expand_less</mat-icon
                    >
                  }
                  <span class="leading-4 text-medium-emphasis">{{
                    t(limitResults ? 'remainingResults' : 'limitResults', {
                      results: limitResults
                        ? getRemainingResultAmount()
                        : resultsLimit
                    })
                  }}</span>
                  @if (limitResults) {
                    <mat-icon class="text-medium-emphasis"
                      >expand_more</mat-icon
                    >
                  }
                </div>
              </button>
            </div>
          }
          @if (isGreaseResultSection(subordinate.titleID)) {
            <div class="p-3">
              <span class="text-caption">{{ t('guideValues') }}</span>
            </div>
          }
        </div>
      </mat-expansion-panel>
    }
  }
</mat-accordion>

<!-- custom content -->
<ng-content></ng-content>

<!-- subordinate display -->
<ng-template
  #subordinateTemplate
  let-subordinate="subordinate"
  let-displayTitle="displayTitle"
>
  <!-- check for existence of subordinate and make it typed -->
  @if (typedSubordinate(subordinate); as subordinate) {
    <!-- text -->
    @if (subordinate.identifier === 'text' && subordinate.text?.length) {
      @for (paragraph of subordinate.text; track paragraph) {
        <p>{{ paragraph }}</p>
      }
    }
    <!-- legalNote -->
    @if (subordinate.identifier === 'legalNote' && subordinate.legal) {
      <p>{{ subordinate.legal }}</p>
    }
    <!-- block -->
    @if (subordinate.identifier === 'block' && displayTitle) {
      <h5 class="pt-4 pb-2">{{ subordinate.title }}</h5>
    }
    <!-- variableBlock-->
    @if (subordinate.identifier === 'variableBlock') {
      <h6 class="pt-4 pb-2">{{ subordinate.title }}</h6>
    }
    <!-- greaseResult -->
    @if (
      subordinate.identifier === 'greaseResult' && subordinate.greaseResult
    ) {
      <div class="grease-result__grid-item mb-6 inline-flex w-full lg:w-1/3">
        <ga-grease-report-result
          [greaseResult]="subordinate.greaseResult"
          [preferredGreaseResult]="preferredGreaseResult"
          [automaticLubrication]="automaticLubrication"
        ></ga-grease-report-result>
      </div>
    }
    <!-- recursive nested subordinates -->
    @if (subordinate.subordinates) {
      @for (
        nestedSubordinate of limitSubordinates(
          subordinate.subordinates,
          subordinate.titleID
        );
        track nestedSubordinate
      ) {
        <ng-container
          [ngTemplateOutlet]="subordinateTemplate"
          [ngTemplateOutletContext]="{
            subordinate: nestedSubordinate,
            displayTitle: true
          }"
        >
        </ng-container>
      }
    }
  }
</ng-template>

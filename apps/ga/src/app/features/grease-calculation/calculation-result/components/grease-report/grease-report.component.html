<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<mat-accordion [multi]="true" *transloco="let t; read: 'calculationResult'">
  <mat-expansion-panel *ngIf="greaseInput">
    <mat-expansion-panel-header (click)="logTogglingInputSection()">
      {{ t('reportSectionInput') }}
    </mat-expansion-panel-header>
    <ga-grease-report-input
      [greaseReportInput]="greaseInput"
    ></ga-grease-report-input>
  </mat-expansion-panel>
  <ng-container *ngFor="let subordinate of subordinates">
    <mat-expansion-panel
      *ngIf="!isInputSection(subordinate)"
      [expanded]="subordinate.defaultOpen"
      [disabled]="isGreaseResultSection(subordinate.titleID)"
    >
      <mat-expansion-panel-header
        [ngClass]="{
          '!cursor-default !text-high-emphasis': isGreaseResultSection(
            subordinate.titleID
          )
        }"
        (click)="
          !subordinate.defaultOpen &&
            !!subordinate.clickHandler &&
            subordinate.clickHandler()
        "
      >
        <mat-panel-title class="w-full">
          <span
            *ngIf="
              isGreaseResultSection(subordinate.titleID);
              else regular_title
            "
            class="truncate"
          >
            {{
              t(
                preferredGreaseResult?.id
                  ? 'resultsWithPreferred'
                  : 'resultsDefault',
                {
                  amount: limitResults ? resultsLimit : getResultAmount(),
                  complete: getResultAmount()
                }
              )
            }}
          </span>
          <ng-template #regular_title>
            <span>{{ subordinate.title }}</span>
          </ng-template>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <div
        class="pb-4 lg:px-6"
        [ngClass]="isGreaseResultSection(subordinate.titleID) ? 'px-0' : 'px-4'"
      >
        <div
          *ngIf="
            isGreaseResultSection(subordinate.titleID) && concept1Impossible()
          "
          class="mx-3 flex min-w-0 flex-row gap-4 rounded border border-attention bg-sunny-yellow bg-opacity-10 p-3 lg:m-0 lg:mb-3"
          [ngClass]="{ '!mb-6': getResultAmount() <= resultsLimit }"
        >
          <div class="text-caption font-normal text-high-emphasis">
            {{ t('concept1Impossible') }}
          </div>
        </div>
        <div>
          <ng-template
            [ngTemplateOutlet]="subordinateTemplate"
            [ngTemplateOutletContext]="{
              subordinate: subordinate,
              displayTitle: false
            }"
          >
          </ng-template>
        </div>
        <div
          class="flex flex-row justify-center"
          *ngIf="
            isGreaseResultSection(subordinate.titleID) &&
            getResultAmount() > resultsLimit
          "
        >
          <button
            class="w-full self-center !py-2 md:!w-auto"
            mat-button
            (click)="toggleLimitResults()"
          >
            <div class="flex flex-col items-center">
              <mat-icon class="text-medium-emphasis" *ngIf="!limitResults"
                >expand_less</mat-icon
              >
              <span class="leading-4 text-medium-emphasis">{{
                t(limitResults ? 'remainingResults' : 'limitResults', {
                  results: limitResults
                    ? getRemainingResultAmount()
                    : resultsLimit
                })
              }}</span>
              <mat-icon class="text-medium-emphasis" *ngIf="limitResults"
                >expand_more</mat-icon
              >
            </div>
          </button>
        </div>
        <div *ngIf="isGreaseResultSection(subordinate.titleID)" class="p-3">
          <span class="text-caption">{{ t('guideValues') }}</span>
        </div>
      </div>
    </mat-expansion-panel>
  </ng-container>
</mat-accordion>

<!-- custom content -->
<ng-content></ng-content>

<!-- subordinate display -->
<ng-template
  #subordinateTemplate
  let-subordinate="subordinate"
  let-displayTitle="displayTitle"
>
  <!-- check for existence of subordinate and make it typed -->
  <ng-container *ngIf="typedSubordinate(subordinate); let subordinate">
    <!-- text -->
    <ng-container
      *ngIf="subordinate.identifier === 'text' && subordinate.text?.length"
    >
      <p *ngFor="let paragraph of subordinate.text">{{ paragraph }}</p>
    </ng-container>

    <!-- legalNote -->
    <ng-container
      *ngIf="subordinate.identifier === 'legalNote' && subordinate.legal"
    >
      <p>{{ subordinate.legal }}</p>
    </ng-container>

    <!-- block -->
    <ng-container *ngIf="subordinate.identifier === 'block' && displayTitle">
      <h5 class="pt-4 pb-2">{{ subordinate.title }}</h5>
    </ng-container>

    <!-- variableBlock-->
    <ng-container *ngIf="subordinate.identifier === 'variableBlock'">
      <h6 class="pt-4 pb-2">{{ subordinate.title }}</h6>
    </ng-container>

    <!-- greaseResult -->
    <ng-container
      *ngIf="
        subordinate.identifier === 'greaseResult' && subordinate.greaseResult
      "
    >
      <div class="grease-result__grid-item mb-6 inline-flex w-full lg:w-1/3">
        <ga-grease-report-result
          [greaseResult]="subordinate.greaseResult"
          [preferredGreaseResult]="preferredGreaseResult"
          [automaticLubrication]="automaticLubrication"
        ></ga-grease-report-result>
      </div>
    </ng-container>

    <!-- recursive nested subordinates -->
    <ng-container *ngIf="subordinate.subordinates">
      <ng-container
        *ngFor="
          let nestedSubordinate of limitSubordinates(
            subordinate.subordinates,
            subordinate.titleID
          )
        "
      >
        <ng-container
          [ngTemplateOutlet]="subordinateTemplate"
          [ngTemplateOutletContext]="{
            subordinate: nestedSubordinate,
            displayTitle: true
          }"
        >
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-container>
</ng-template>

import { computed, inject, Injectable } from '@angular/core';
import { toObservable, toSignal } from '@angular/core/rxjs-interop';

import { switchMap } from 'rxjs';

import { TranslocoService } from '@jsverse/transloco';

import {
  Colors,
  ConditionalPageBreak,
  ControlCommands,
  DisclaimerFooter,
  FontConfig,
  FontResolverService,
  PDFDocument,
  PDFHeader,
} from '@schaeffler/pdf-generator';

import { SettingsFacade } from '@ga/core/store';
import { PartnerVersion } from '@ga/shared/models';

import { GreasePdfReportModel, PDFGreaseReportResult } from '../../models';
import { GreaseReportDataGeneratorService } from '../grease-report-data-generator.service';
import { GreaseReportPdfFileSaveService } from './grease-report-pdf-file-save.service';
import { PdfInputsService } from './sections/pdf-inputs.service';
import { PdfMessagesService } from './sections/pdf-messages.service';
import { PdfResultsService } from './sections/pdf-results.service';
import {
  PDFStoreButtonComponent,
  QR_APPLE,
  QR_PLAY,
} from './sections/pdf-store-buttons';

const SCHMECKTHAL_PDF_LOGO =
  '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';

@Injectable({ providedIn: 'root' })
export class PdfGenerationService {
  private readonly settingsFacade = inject(SettingsFacade);
  private readonly partnerVersion = toSignal(
    this.settingsFacade.partnerVersion$
  );
  private readonly fontResolver = inject(FontResolverService);
  private readonly pdfFileSaveService = inject(GreaseReportPdfFileSaveService);
  private readonly pdfInputsService = inject(PdfInputsService);
  private readonly pdfMessagesService = inject(PdfMessagesService);
  private readonly pdfResultsService = inject(PdfResultsService);
  private readonly translocoService = inject(TranslocoService);
  private readonly languageChanges = toSignal(
    this.translocoService.langChanges$,
    {
      initialValue: this.translocoService.getActiveLang(),
    }
  );

  private readonly dataGeneratorService = inject(
    GreaseReportDataGeneratorService
  );

  readonly customLogo = computed(() =>
    this.partnerVersion() === PartnerVersion.Schmeckthal
      ? SCHMECKTHAL_PDF_LOGO
      : undefined
  );

  readonly activeLang = computed(
    () => this.languageChanges() ?? this.translocoService.getActiveLang()
  );

  private readonly activeLang$ = toObservable(this.activeLang);

  readonly fonts = toSignal(
    this.activeLang$.pipe(
      switchMap((lang) => this.fontResolver.fetchForLocale(lang))
    ),
    { initialValue: [] as FontConfig[] }
  );

  public async generatePdf(report: GreasePdfReportModel): Promise<void> {
    const fonts = this.fonts();
    const reportTitle = this.getReportTitle(report.reportTitle);

    const resultData: PDFGreaseReportResult[] =
      await this.dataGeneratorService.prepareReportResultData(
        report.results,
        this.partnerVersion()
      );

    const doc = new PDFDocument()
      .addFont(...fonts)
      .setTextColor(Colors.DarkGreyVariant)
      .setPageMargin({ left: 7, right: 7, top: 6, bottom: 10 })
      .setDebug(false)
      .addFooter(this.getPdfFooter(report.legalNote))
      .addHeader(this.getPdfHeader(reportTitle, report.sectionSubTitle))
      .setComponentSpacing(1.5)
      .addComponent(...this.pdfInputsService.getInputsSection(report))
      .addComponent(ControlCommands.PageBreak);

    const resultComponents =
      this.pdfResultsService.generateResultsSection(resultData);
    resultComponents.forEach((component) => {
      doc.addComponent(component);
      doc.addComponent(new ConditionalPageBreak(20));
    });
    doc.addComponent(ControlCommands.PageBreak);
    doc
      .addComponent(...this.pdfMessagesService.getMessagesSection(report))
      .addComponent(
        new PDFStoreButtonComponent({
          buttons: [
            { store: 'AppStore', qrImageData: QR_APPLE },
            { store: 'PlayStore', qrImageData: QR_PLAY },
          ],
        })
      );
    doc.generate();

    const reportDate = new Intl.DateTimeFormat(
      this.translocoService.getActiveLang()
    ).format(Date.now());

    const fileName = this.getFileName(reportTitle, reportDate);

    this.pdfFileSaveService.saveAndOpenFile(doc, fileName);
  }

  private getReportTitle(reportTitle: string): string {
    return `Grease App ${reportTitle}`;
  }

  private getFileName(reportTitle: string, date: string): string {
    const partnerPrefix =
      this.partnerVersion() === PartnerVersion.Schmeckthal
        ? 'Schmeckthal Gruppe '
        : '';

    return `${partnerPrefix}${reportTitle} - ${date}.pdf`;
  }

  private getPdfHeader(
    reportTitle: string,
    hint24hOperation: string
  ): PDFHeader {
    return new PDFHeader({
      reportTitle,
      heading: reportTitle,
      headingDescription: hint24hOperation,
      date: {
        dateLocale: this.translocoService.getActiveLang(),
      },
      customLogo: this.customLogo(),
    });
  }

  private getPdfFooter(legalNote: string): DisclaimerFooter {
    return new DisclaimerFooter({
      disclaimerText: legalNote,
    });
  }
}

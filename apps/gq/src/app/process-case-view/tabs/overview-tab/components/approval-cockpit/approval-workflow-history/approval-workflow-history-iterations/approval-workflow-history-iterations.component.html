<ng-container
  *transloco="
    let t;
    read: 'processCaseView.tabs.overview.approvalCockpit.workflow'
  "
>
  <ng-container *ngrxLet="workflowEvents">
    <!--auto approved event does not show a title for the Iterations-->
    @if (!autoApprovedEvent) {
      <!--check which title to display find the template-->
      @if (rejectedEvent || cancelledEvent) {
        @if (cancelledEvent) {
          <gq-approval-workflow-history-section
            [icon]="'remove_circle'"
            [iconColor]="'text-icon-error'"
            [title]="t('cancelledLabel')"
            [titleTextColor]="'text-error'"
            [subtitle]="
              t('eventCreatedBy', {
                date:
                  cancelledEvent.eventDate
                  | translocoDate: translocoDatePipeConfig,
                user:
                  cancelledEvent.user | approverDisplay: t('unknownApprover'),
              })
            "
          >
          </gq-approval-workflow-history-section>
        }
        @if (rejectedEvent) {
          <gq-approval-workflow-history-section
            [icon]="'warning'"
            [iconColor]="'text-icon-error'"
            [title]="t('rejectedLabel')"
            [titleTextColor]="'text-error'"
            class="text-error"
            [subtitle]="
              t('eventCreatedBy', {
                date:
                  rejectedEvent.eventDate
                  | translocoDate: translocoDatePipeConfig,
                user:
                  rejectedEvent.user | approverDisplay: t('unknownApprover'),
              })
            "
          >
          </gq-approval-workflow-history-section>
        }
      } @else {
        @if (inApproval) {
          <gq-approval-workflow-history-section
            [icon]="'autorenew'"
            [iconColor]="'text-icon-info'"
            [title]="t('inApprovalLabel')"
            [subtitle]="
              t('approversApproved', {
                variable: receivedApprovalsOfRequiredApprovals,
              })
            "
          >
          </gq-approval-workflow-history-section>
        }
        @if (isApproved) {
          <gq-approval-workflow-history-section
            [icon]="'check_circle_outline'"
            [iconColor]="'text-icon-success'"
            [title]="t('inApprovalLabel')"
            [subtitle]="
              t('approversApproved', {
                variable: receivedApprovalsOfRequiredApprovals,
              })
            "
          >
          </gq-approval-workflow-history-section>
        }
      }
    }

    <!-- all Events in chronological order -->
    <!-- if no items for iterations, do not show IterationsSection but display a timeline line -->
    @if (workflowEvents.length < 1) {
      <div
        class="timeline noIterations border-l-2 border-l-border border-dashed h-[1.5rem] bg border-y-border ml-3"
      ></div>
    }
    <!-- show Iterations Section-->
    @if (workflowEvents.length >= 1) {
      <div
        class="ml-3"
        [ngClass]="[
          inApproval ? 'border-dashed border-l-border' : 'border-solid',
          rejectedEvent || cancelledEvent ? 'text-icon-error' : '',
          isApproved ? 'text-icon-success' : '',
        ]"
      >
        <!--when cancelled or rejected event, the toggle button has no timeline -> property showTimeline-->
        @if (!iterationVisible) {
          <gq-approval-workflow-history-section
            class="cursor-pointer"
            [icon]="'add'"
            [iconColor]="'text-on-surface opacity-[0.38]'"
            [title]="
              t('viewIterationsLabel', { amount: workflowEvents.length })
            "
            [titleTextColor]="'text-on-surface-variant'"
            [isButton]="true"
            [isIterationItem]="true"
            [borderClass]="[
              inApproval ? 'border-dashed border-l-border' : 'border-solid',
              rejectedEvent || cancelledEvent ? 'text-icon-error' : '',
              isApproved ? 'text-icon-success' : '',
            ]"
            [showTimeline]="!(!!rejectedEvent || !!cancelledEvent)"
            (click)="toggleIteration()"
          >
          </gq-approval-workflow-history-section>
        }
        @if (iterationVisible) {
          <!-- we want the events asc for the iterations-->
          @for (
            event of workflowEvents?.slice().reverse();
            track event;
            let i = $index
          ) {
            <!--the very last event of a rejected/cancelled workflow will display an interrupted timeline-->
            <gq-approval-workflow-history-section
              [title]="t(event.event)"
              [subtitle]="
                t('eventCreatedBy', {
                  date:
                    event.eventDate | translocoDate: translocoDatePipeConfig,
                  user: event.user | approverDisplay: t('unknownApprover'),
                })
              "
              [comment]="event.comment"
              [isIterationItem]="true"
              [iterationItemIconColor]="iconColor"
              [borderClass]="[
                inApproval ? 'border-dashed border-l-border' : 'border-solid',
                rejectedEvent || cancelledEvent ? 'text-icon-error' : '',
                isApproved ? 'text-icon-success' : '',
              ]"
              [showTimeline]="true"
              [showInterruptedTimeline]="
                (!!rejectedEvent || !!cancelledEvent) &&
                i === workflowEvents.length - 1
              "
            >
            </gq-approval-workflow-history-section>
          }
        }
        <!--when cancelled or rejected event, the toggle button has no timeline -> property showTimeline-->
        @if (iterationVisible) {
          <gq-approval-workflow-history-section
            class="cursor-pointer"
            [icon]="'remove'"
            [iconColor]="'text-on-surface opacity-[0.38]'"
            [title]="
              t('hideIterationsLabel', { amount: workflowEvents.length })
            "
            [titleTextColor]="'text-on-surface-variant'"
            [isButton]="true"
            [isIterationItem]="true"
            [borderClass]="[
              inApproval ? 'border-dashed border-l-border' : 'border-solid',
              rejectedEvent || cancelledEvent ? 'text-icon-error' : '',
              isApproved ? 'text-icon-success' : '',
            ]"
            [showTimeline]="!(!!rejectedEvent || !!cancelledEvent)"
            (click)="toggleIteration()"
          >
          </gq-approval-workflow-history-section>
        }
      </div>
    }
    <!--###############                 TEMPLATES for Title of Iterations             #################-->
    <!--###############  !!! Iterations Title does NOT display the events comment !!! #################-->
  </ng-container>
</ng-container>

<div
  class="flex h-full w-full flex-col md:flex-row"
  *transloco="let t; read: 'materialsSupplierDatabase'"
>
  <div class="border-border border-r">
    <mac-msd-navigation
      [activeNavigationLevel]="activeNavigationLevel"
      class="h-full w-full"
    ></mac-msd-navigation>
  </div>
  <div
    class="flex w-full flex-1 flex-col md:p-4 md:pb-0 md:pr-0"
    *ngrxLet="navigation$ as navigation"
  >
    <ng-container>
      <mac-quick-filter></mac-quick-filter>

      <div class="flex w-full flex-1">
        <div class="h-full w-full">
          <ng-container
            *ngIf="navigation.materialClass !== 'sap'; else serverSideGrid"
          >
            <ag-grid-angular
              class="ag-theme-material border-border h-full border"
              [masterDetail]="true"
              [detailCellRenderer]="detailCellRenderer"
              [detailRowAutoHeight]="true"
              [suppressCellFocus]="true"
              [columnDefs]="columnDefs"
              [defaultColDef]="defaultColDef"
              [sideBar]="sidebar"
              [enableCellTextSelection]="true"
              [rowData]="result$ | ngrxPush"
              [tooltipShowDelay]="agGridTooltipDelay"
              rowSelection="multiple"
              [suppressRowClickSelection]="true"
              (gridReady)="onGridReady($event)"
              (filterChanged)="onFilterChange($event)"
              (firstDataRendered)="setAgGridFilter($event)"
              [rowClass]="['!border-l-0', '!border-t-0']"
              [rowClassRules]="{
                '!bg-opacity-5 !bg-error': isBlockedRow,
                '!bg-opacity-5 !bg-nordic-blue': isRecentlyChangedRow
              }"
              (columnVisible)="onColumnChange($event)"
              (columnMoved)="onColumnChange($event)"
              (columnResized)="onColumnChange($event)"
              (sortChanged)="onColumnChange($event)"
            ></ag-grid-angular>
          </ng-container>
          <ng-template #serverSideGrid>
            <ag-grid-angular
              class="ag-theme-material border-border h-full border"
              [masterDetail]="true"
              [detailCellRenderer]="detailCellRenderer"
              [detailRowAutoHeight]="true"
              rowModelType="serverSide"
              [columnDefs]="columnDefs"
              [defaultColDef]="defaultColDef"
              [serverSideInfiniteScroll]="true"
              [serverSideFilterOnServer]="true"
              [serverSideSortOnServer]="true"
              [suppressCellFocus]="true"
              [sideBar]="sidebar"
              [rowData]="serverSideRowData"
              [enableCellTextSelection]="true"
              [tooltipShowDelay]="agGridTooltipDelay"
              [rowClass]="['!border-l-0', '!border-t-0']"
              [rowClassRules]="{
                '!bg-opacity-5 !bg-error': isBlockedRow,
                '!bg-opacity-5 !bg-nordic-blue': isRecentlyChangedRow
              }"
              [cacheBlockSize]="100"
              [maxBlocksInCache]="4"
              [blockLoadDebounceMillis]="500"
              [maxConcurrentDatasourceRequests]="1"
              [context]="{ dataService }"
              (gridReady)="onGridReady($event, true)"
              (filterChanged)="onFilterChange($event)"
              (columnVisible)="onColumnChange($event)"
              (columnMoved)="onColumnChange($event)"
              (columnResized)="onColumnChange($event)"
              (sortChanged)="onColumnChange($event)"
            ></ag-grid-angular>
          </ng-template>
        </div>
      </div>
    </ng-container>
    <div
      class="flex flex-col items-center justify-start gap-4 p-4 pl-0 md:flex-row"
    >
      <ng-container
        *ngIf="!(hasMinimizedDialog$ | ngrxPush); else resumeButton"
      >
        <ng-container
          *ngIf="
            navigation.materialClass !== materialClass.SAP_MATERIAL;
            else upload
          "
        >
          <button
            mat-raised-button
            color="primary"
            [disabled]="
              !(hasEditorRole$ | ngrxPush) ||
              !editableClass(navigation.materialClass)
            "
            (click)="openDialog(false)"
          >
            <mat-icon class="material-icons-outlined">add</mat-icon>
            <span>{{ t('addItem') }}</span>
          </button>
        </ng-container>
        <button
          mat-raised-button
          class="!bg-nordic-blue"
          (click)="openDialogMultiEdit()"
          *ngIf="countSelectedNodes() >= 2"
        >
          <mat-icon class="material-icons-outlined">edit</mat-icon>
          <span class="text-white">{{
            t('multiEdit', { count: countSelectedNodes() })
          }}</span>
        </button>
      </ng-container>
      <ng-template #resumeButton>
        <button
          mat-raised-button
          class="!bg-nordic-blue"
          [disabled]="
            !(hasEditorRole$ | ngrxPush) ||
            !editableClass(navigation.materialClass)
          "
          (click)="resumeDialog()"
        >
          <mat-icon class="text-white">play_arrow</mat-icon>
          <span class="text-white">{{ t('resume') }}</span>
        </button>
      </ng-template>
      <ng-template #upload>
        <ng-container
          *ngIf="
            isSapMaterialsUploadStatusDialogMinimized$ | ngrxPush;
            then uploadInProgressButton;
            else uploadButton
          "
        >
        </ng-container>
      </ng-template>
      <ng-template #uploadButton>
        <button
          mat-raised-button
          [disabled]="!(hasMatnrUploaderRole$ | ngrxPush)"
          color="primary"
          (click)="openSapMaterialsUploadDialog()"
        >
          <mat-icon class="material-icons-outlined">add</mat-icon>
          <span>{{ t('uploadItem') }}</span>
        </button>
      </ng-template>
      <ng-template #uploadInProgressButton>
        <button
          mat-raised-button
          class="!bg-nordic-blue"
          (click)="openSapMaterialsUploadStatusDialog()"
        >
          <div class="flex flex-row gap-x-2">
            <span class="text-white">{{ t('uploadInProgress') }}</span>
            <mat-spinner
              class="my-auto"
              color="accent"
              diameter="14"
            ></mat-spinner>
          </div>
        </button>
      </ng-template>

      <button
        mat-button
        color="primary"
        (click)="exportExcel()"
        [disabled]="navigation.materialClass === 'sap'"
      >
        <mat-icon class="material-icons-outlined">download</mat-icon>
        <span>{{ t('export') }}</span>
      </button>
      <button
        mat-button
        color="primary"
        [disabled]="isDefaultAgGridFilter()"
        (click)="resetForm()"
      >
        <mat-icon class="material-icons-outlined">sync</mat-icon>
        <span>{{ t('resetTable') }}</span>
      </button>
      <div
        class="flex flex-grow flex-row items-center justify-start gap-4"
        *ngrxLet="sapMaterialsRows$ as sapMaterialsRows"
      >
        <div class="flex flex-col">
          <div class="text-caption text-low-emphasis">
            {{
              t('allClass', {
                class: t(navigation.navigationLevel)
              })
            }}
          </div>
          <div class="text-caption text-high-emphasis">
            {{
              (navigation.materialClass !== 'sap'
                ? (resultCount$ | ngrxPush)
                : sapMaterialsRows?.totalRows) || 0
            }}
          </div>
        </div>
        <div class="flex flex-col">
          <div class="text-caption text-low-emphasis">{{ t('subtotal') }}</div>
          <div class="text-caption text-high-emphasis">
            {{
              (navigation.materialClass !== 'sap'
                ? agGridApi?.getDisplayedRowCount()
                : sapMaterialsRows?.subTotalRows) || 0
            }}
          </div>
        </div>
      </div>
      <button
        mat-button
        color="primary"
        (click)="
          navigation.materialClass !== 'sap'
            ? fetchResult()
            : refreshServerSide()
        "
      >
        <mat-icon class="material-icons-outlined">refresh</mat-icon>
        <span>{{ t('reload') }}</span>
      </button>
    </div>
  </div>
  <ng-container
    *ngIf="(optionsLoading$ | ngrxPush) || (resultLoading$ | ngrxPush)"
  >
    <div class="fixed flex h-full w-full flex-col items-center md:pt-[10%]">
      <mat-spinner></mat-spinner>
    </div>
  </ng-container>
</div>

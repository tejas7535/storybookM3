<mat-form-field
  [formGroup]="form()"
  appearance="outline"
  class="full-width auto-hide-chips"
  [class.show-hidden]="isInputFocused || isAutocompleteOpen"
  *transloco="let t"
>
  <!-- Label -->
  <mat-label>{{ autocompleteLabel() || '' }}</mat-label>

  <!-- The chip list to show the selected values -->
  <mat-chip-grid #chipList [disabled]="control().disabled">
    @for (
      option of control().value;
      track option.id + '-' + getOptionName()(option)
    ) {
      <mat-chip-row
        matTooltipTouchGestures="auto"
        [matTooltip]="getOptionTooltip()(option)"
        (removed)="remove(option)"
      >
        <!-- Chip name -->
        <span>{{ getOptionName()(option) }}</span>

        <!-- Chip delete button -->
        <button [attr.aria-label]="'remove ' + option.text" matChipRemove>
          <mat-icon matChipRemove>cancel</mat-icon>
        </button>
      </mat-chip-row>
    }

    @if (control().value.length > 2) {
      <span class="hidden-count">+{{ control().value.length - 2 }}</span>
    }

    <!-- Input field (search field) -->
    <input
      #multiAutocomplete
      #trigger="matAutocompleteTrigger"
      [matAutocomplete]="auto"
      [matChipInputAddOnBlur]="true"
      [matChipInputFor]="chipList"
      [formControl]="searchControl()"
      (focus)="onFocus()"
      (blur)="onBlur()"
      (click)="onInputClick()"
    />
  </mat-chip-grid>

  <!-- The autocomplete -->
  <mat-autocomplete
    #auto="matAutocomplete"
    (opened)="onAutocompleteOpened()"
    (closed)="onAutocompleteClosed()"
    (optionSelected)="onOptionSelected($event)"
    [class]="panelClass()"
  >
    <!-- Render the options only, if there are no error and the data are not loading -->
    @if (!loading() && !loadingError()) {
      @for (
        option of options();
        track option.id + '-' + getOptionLabel()(option)
      ) {
        <mat-option [value]="option">
          {{ getOptionLabel()(option) }}
        </mat-option>
      }
    }

    <!-- Show text for is loading -->
    @if (loading()) {
      <mat-option [disabled]="true">{{
        t('globalSelection.dropdown.loading')
      }}</mat-option>
    } @else {
      @if (searchControl()?.value?.length === 1) {
        <mat-option [disabled]="true">
          {{ t('globalSelection.dropdown.minOne') }}
        </mat-option>
      } @else if (
        options()?.length === 0 &&
        (isPreloaded || searchControl()?.value?.length > 1)
      ) {
        <!-- Show text for no data available -->
        <mat-option [disabled]="true">{{ t('hint.noData') }}</mat-option>
      }
    }

    <!-- Show Loading Error -->
    @if (loadingError()) {
      <mat-error>{{ loadingError() }}</mat-error>
    }
  </mat-autocomplete>

  <!-- Add an arrow, so it will look like a dropdown  -->
  @if (addDropdownIcon()) {
    <mat-icon
      matSuffix
      (click)="togglePanel()"
      (keydown)="keyHandler($event)(togglePanel.bind(this))"
      class="dropdown"
    >
      arrow_drop_down
    </mat-icon>
  }

  @if (control().value?.length > 0 && addClearButton()) {
    <button
      matSuffix
      mat-icon-button
      aria-label="Clear"
      (click)="onClear()"
      [disabled]="control().disabled"
    >
      <mat-icon>close</mat-icon>
    </button>
  }

  <!-- Error -->
  @if (control().hasError('required')) {
    <mat-error>{{ t('generic.validation.missing_fields') }}</mat-error>
  }

  <!-- custom errors -->
  @if (errorMessage()) {
    <mat-error>{{ errorMessage() }}</mat-error>
  }
</mat-form-field>

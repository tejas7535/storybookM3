<!-- <pre>{{ dialog | json }}</pre> -->

<ng-container *transloco="let t">
  <cae-dynamic-form
    [description]="dialog"
    [model]="model"
    [object]="object"
    (loaded)="dynamicFormLoaded($event)"
  >
    <div
      *caeLayout="let metaArray; let pages = pages; let form = form"
      class="content"
    >
      <div class="-ml-4">
        <mm-pages-stepper
          #stepper
          [pages]="pages"
          [maxPageId]="maxPageId$ | ngrxPush"
          [activePageId]="activePageId$ | ngrxPush"
          [inactivePageId]="inactivePageId$ | ngrxPush"
          (activePageIdChange)="handleActivePageIdChange($event)"
        >
        </mm-pages-stepper>
      </div>
      <div *ngIf="activeBearing$ | ngrxPush as activeBearing" class="mb-4">
        <span class="text-subtitle-1">
          {{ activeBearing }}
        </span>
      </div>
      <div class="w-full">
        <ng-container
          *ngIf="(activePageId$ | ngrxPush) === RSY_PAGE_BEARING_TYPE"
        >
          <div class="mt-8 sm:mb-8 mb-4 max-w-sm">
            <mm-bearing-search
              (bearing)="selectBearing($event)"
            ></mm-bearing-search>
          </div>
          <div class="mb-4">
            <schaeffler-horizontal-separator [text]="t('form.searchManually')">
              <mat-slide-toggle
                color="primary"
                [(ngModel)]="manualBearing"
              ></mat-slide-toggle
            ></schaeffler-horizontal-separator>
          </div>
        </ng-container>
        <ng-container
          *ngFor="let pagedMeta of pagedMetas$ | ngrxPush; index as pageIndex"
        >
          <ng-container
            *ngIf="
              pagedMeta.page.id === (activePageId$ | ngrxPush) &&
              (manualBearing || pagedMeta.page.id !== RSY_PAGE_BEARING_TYPE)
            "
          >
            <ng-container *ngFor="let meta of pagedMeta.metas">
              <ng-container
                *ngIf="
                  meta.member.id !== RSY_BEARING_SERIES &&
                    meta.member.id !== RSY_BEARING;
                  else inBox
                "
              >
                <div
                  *ngIf="
                    meta.page.visible &&
                    !isCalculationOptions(pagedMeta.page.id)
                  "
                >
                  <div
                    [ngClass]="{
                      'max-w-md sm:w-[26rem] border p-4 border-border rounded mt-8':
                        meta.member.id === IDMM_MEASSURING_METHOD
                    }"
                  >
                    <h6
                      *ngIf="
                        meta.member.text &&
                        hasHeadline(meta.page.id, meta.member.id)
                      "
                    >
                      {{ t(meta.member.text) }}
                    </h6>
                    <div
                      [ngClass]="{
                        '-mb-5 mt-4': meta.member.id === IDMM_MEASSURING_METHOD
                      }"
                    >
                      <div
                        *ngIf="meta.member.id === IDMM_MOUNTING_METHOD"
                        class="mt-4"
                      >
                        <schaeffler-horizontal-separator
                          *ngIf="measuringMethodSet()"
                          [text]="
                            t('form.select', {
                              fieldname: meta.member.text | transloco
                            })
                          "
                        ></schaeffler-horizontal-separator>
                      </div>
                      <cae-member-control
                        [class.wide]="!meta.member.text"
                        [meta]="meta"
                      ></cae-member-control>
                    </div>
                  </div>
                </div>
              </ng-container>
              <ng-template #inBox>
                <ng-template #inBoxControl>
                  <h6
                    *ngIf="
                      meta.page.visible &&
                      meta.member.text &&
                      hasHeadline(meta.page.id, meta.member.id)
                    "
                  >
                    {{ t(meta.member.text) }}
                  </h6>
                  <cae-member-control
                    [class.wide]="!meta.member.text"
                    [meta]="meta"
                  ></cae-member-control>
                </ng-template>
              </ng-template>
            </ng-container>

            <div
              [ngClass]="{
                'w-full border border-border p-4 rounded mt-8':
                  isCalculationOptions(pagedMeta.page.id)
              }"
            >
              <div
                [ngClass]="{
                  'border border-border p-4 rounded mt-8 sm:max-w-xs':
                    pagedMeta.page.id === RSY_PAGE_BEARING_TYPE &&
                    form.value.objects[0].properties[0].value
                }"
              >
                <ng-container *ngFor="let template of inBoxTemplates">
                  <ng-container [ngTemplateOutlet]="template"></ng-container>
                </ng-container>

                <div
                  class="mb-4"
                  *ngIf="isCalculationOptions(pagedMeta.page.id)"
                >
                  <mm-calculation-options
                    [pageMeta]="pagedMeta"
                  ></mm-calculation-options>
                </div>

                <ng-container *ngrxLet="pagedMetas$ as pagedMetas">
                  <button
                    mat-raised-button
                    *ngIf="
                      stepper.hasNext &&
                      (pagedMeta.valid$ | ngrxPush) &&
                      pagedMeta.page.id !== PAGE_MOUNTING_MANAGER_SEAT &&
                      pagedMeta.page.id !==
                        PAGE_MOUNTING_MANAGER_MEASURING_MOUTING_METHODS
                    "
                    [disabled]="!(pagedMeta.valid$ | ngrxPush)"
                    color="primary"
                    (click)="
                      next(pagedMeta.page.id, pagedMetas, stepper);
                      stepper.hasResultNext && resultPage.send(form)
                    "
                    class="text-button uppercase w-full md:max-w-xs"
                  >
                    {{
                      stepper.hasResultNext
                        ? t('form.calculateResults')
                        : t('form.select', {
                            fieldname: activePageName$ | ngrxPush | transloco
                          })
                    }}
                  </button>
                </ng-container>
              </div>
            </div>
          </ng-container>
        </ng-container>

        <mm-result-page
          [active]="!stepper.hasNext"
          [bearing]="activeBearing$ | ngrxPush"
          #resultPage
        ></mm-result-page>
        <!-- <pre>{{ form.value | json }}</pre> -->
      </div>
    </div>
  </cae-dynamic-form>
</ng-container>

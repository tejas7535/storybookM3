<mat-form-field [appearance]="appearance" class="w-full">
  <mat-label *ngIf="label">{{ label }}</mat-label>
  <input
    type="text"
    [matAutocomplete]="auto"
    matInput
    [formControl]="searchControl"
    [class.text-high-emphasis]="!control.value"
    [class.text-link]="control.value"
    (blur)="onTouched()"
    [placeholder]="placeholder"
  />
  <mat-autocomplete
    #auto="matAutocomplete"
    [displayWith]="displayWithFn"
    [autoActiveFirstOption]="true"
    (optionSelected)="onOptionSelected($event.option.value)"
  >
    <div>
      <ng-content
        select="[loadingContent]"
        *ngIf="loading; else searchOptionsTemplate"
      ></ng-content>
      <ng-template #searchOptionsTemplate>
        <div
          *ngIf="filteredOptions?.length === 0 && noResultsText"
          class="flex h-12 w-full flex-col content-around"
        >
          <div class="relative my-auto text-center text-high-emphasis">
            {{ noResultsText }}
          </div>
        </div>
        <ng-content select="[errorContent]" *ngIf="error"></ng-content>
        <div *ngIf="!loading && !error">
          <!-- Current implementation pass html into option string, implementation could be simplified if we use just {{title}} value in standard template, possible future improvement -->
          <ng-container *ngIf="!customOptionsRef">
            <mat-option
              *ngFor="let option of filteredOptions; trackBy: trackByFn"
              [value]="option"
              [innerHTML]="option.title"
              [disabled]="option.disabled"
              class="!h-10 !text-caption"
            >
            </mat-option>
          </ng-container>

          <!-- custom template implementation which gives more control on inserted html -->
          <ng-container *ngIf="customOptionsRef">
            <mat-option
              *ngFor="let option of filteredOptions; trackBy: trackByFn"
              [value]="option"
              [disabled]="option.disabled"
              class="!text-caption"
            >
              <ng-container
                [ngTemplateOutletContext]="{ option: option }"
                [ngTemplateOutlet]="customOptionsRef"
              >
              </ng-container>
            </mat-option>
          </ng-container>
        </div>
      </ng-template>
      <ng-container
        *ngIf="
          loading || error || (filteredOptions?.length === 0 && noResultsText)
        "
      >
        <mat-option #dummyOption class="!hidden !h-0"></mat-option>
      </ng-container>
    </div>
  </mat-autocomplete>
  <div matTextPrefix *ngIf="isRoundedSearchComponent">
    <mat-icon class="align-middle" *ngIf="searchControl.value">search</mat-icon>
  </div>
  <div matSuffix>
    <mat-icon *ngIf="!searchControl.value; else clearButtonTemplate"
      >search</mat-icon
    >
    <ng-template #clearButtonTemplate>
      <button mat-icon-button (click)="onSearchReset()">
        <mat-icon>clear</mat-icon>
      </button>
    </ng-template>
  </div>

  <mat-error>
    <ng-content select="[matErrorContent]"></ng-content>
  </mat-error>
</mat-form-field>

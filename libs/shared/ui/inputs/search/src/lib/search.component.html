<mat-form-field [appearance]="appearance" class="w-full">
  @if (label) {
    <mat-label>{{ label }}</mat-label>
  }
  <input
    type="text"
    [matAutocomplete]="auto"
    matInput
    [formControl]="searchControl"
    [class.text-high-emphasis]="!control.value"
    [class.text-link]="control.value"
    (blur)="onTouched()"
    [placeholder]="placeholder"
  />
  <mat-autocomplete
    #auto="matAutocomplete"
    [displayWith]="displayWithFn"
    [autoActiveFirstOption]="true"
    (optionSelected)="onOptionSelected($event.option.value)"
  >
    <div>
      @if (loading) {
        <ng-content select="[loadingContent]"></ng-content>
      } @else {
        @if (filteredOptions?.length === 0 && noResultsText) {
          <div class="flex h-12 w-full flex-col content-around">
            <div class="relative my-auto text-center text-high-emphasis">
              {{ noResultsText }}
            </div>
          </div>
        }
        @if (error) {
          <ng-content select="[errorContent]"></ng-content>
        }
        @if (!loading && !error) {
          <div>
            <!-- Current implementation pass html into option string, implementation could be simplified if we use just {{title}} value in standard template, possible future improvement -->
            @if (!customOptionsRef) {
              @for (option of filteredOptions; track $index) {
                <mat-option
                  [value]="option"
                  [innerHTML]="option.title"
                  [disabled]="option.disabled"
                  class="!h-10 !text-caption"
                >
                </mat-option>
              }
            }
            <!-- custom template implementation which gives more control on inserted html -->
            @if (customOptionsRef) {
              @for (option of filteredOptions; track $index) {
                <mat-option
                  [value]="option"
                  [disabled]="option.disabled"
                  class="!text-caption"
                >
                  <ng-container
                    [ngTemplateOutletContext]="{ option: option }"
                    [ngTemplateOutlet]="customOptionsRef"
                  >
                  </ng-container>
                </mat-option>
              }
            }
          </div>
        }
      }
      @if (
        loading || error || (filteredOptions?.length === 0 && noResultsText)
      ) {
        <mat-option #dummyOption class="!hidden !h-0"></mat-option>
      }
    </div>
  </mat-autocomplete>
  @if (isRoundedSearchComponent) {
    <div matTextPrefix>
      @if (searchControl.value) {
        <mat-icon class="align-middle">search</mat-icon>
      }
    </div>
  }
  <div matSuffix>
    @if (!searchControl.value) {
      <mat-icon>search</mat-icon>
    } @else {
      <button mat-icon-button (click)="onSearchReset()">
        <mat-icon>clear</mat-icon>
      </button>
    }
  </div>

  <mat-error>
    <ng-content select="[matErrorContent]"></ng-content>
  </mat-error>
</mat-form-field>

<div id="schaeffler-report">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <h6>{{ title }}</h6>
      </mat-card-title>
      <mat-card-subtitle *ngIf="subtitle" class="text-caption">
        {{ subtitle }}
      </mat-card-subtitle>
    </mat-card-header>
    <div *ngIf="downloadReport" class="absolute right-0 top-0 p-2">
      <a
        type="button"
        mat-icon-button
        *ngIf="downloadReport"
        class="focus:outline-none"
        [href]="downloadReport"
      >
        <mat-icon class="text-light">save</mat-icon>
      </a>
    </div>
    <!-- html report -- string -->
    <ng-container *ngIf="htmlReport; else jsonReportDisplay">
      <mat-card-content *ngIf="htmlResult$ | ngrxPush as result">
        <mat-accordion>
          <mat-expansion-panel
            *ngFor="let entry of result"
            [expanded]="entry.defaultOpen"
          >
            <mat-expansion-panel-header class="text-body-1">
              <mat-panel-title>{{ entry.title }}</mat-panel-title>
            </mat-expansion-panel-header>
            <div class="px-6 pb-4">
              <ng-container *ngFor="let content of entry.content">
                <div
                  [ngClass]="
                    content.nodeName === 'TABLE' ? '-mx-6 md:mx-0' : 'ml-0 mr-0'
                  "
                  class="
                    leading-normal
                    m-3
                    overflow-x-scroll
                    sm:overflow-x-visible
                  "
                  [innerHtml]="content.outerHTML | safeHtml"
                ></div>
              </ng-container>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </mat-card-content>
    </ng-container>
    <!-- json report -- { title: string; content: Subordinate }[] -->
    <ng-template #jsonReportDisplay>
      <mat-card-content *ngIf="jsonResult$ | ngrxPush as result">
        <mat-accordion>
          <mat-expansion-panel
            *ngFor="let section of result"
            [expanded]="section.defaultOpen"
          >
            <mat-expansion-panel-header class="text-body-1">
              <mat-panel-title *transloco="let t">
                {{ section.title }}
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="px-6 pb-4">
              <ng-template
                [ngTemplateOutlet]="subordinateTemplate"
                [ngTemplateOutletContext]="{
                  subordinate: section,
                  displayTitle: false
                }"
              >
              </ng-template>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </mat-card-content>
    </ng-template>
    <ng-content></ng-content>
  </mat-card>

  <!-- subordinate display -->
  <ng-template
    #subordinateTemplate
    let-subordinate="subordinate"
    let-displayTitle="displayTitle"
  >
    <!-- debug -->
    <!-- <div>{{ subordinate | json }}</div>
  <div *ngIf="!subordinate">no subordinate</div> -->

    <!-- textPairList -->
    <ng-container *ngIf="subordinate.identifier === 'textPairList'">
      <div class="flex flex-row gap-4">
        <div class="flex flex-col">
          <div *ngFor="let entry of subordinate.entries">{{ entry[0] }}</div>
        </div>
        <div class="flex flex-col flex-grow">
          <div *ngFor="let entry of subordinate.entries">{{ entry[1] }}</div>
        </div>
      </div>
    </ng-container>

    <!-- textBlock -->
    <!-- no handling needed as of now -->

    <!-- text -->
    <ng-container *ngIf="subordinate.identifier === 'text'">
      <p *ngFor="let paragraph of subordinate.text">{{ paragraph }}</p>
    </ng-container>

    <!-- legalNote -->
    <ng-container *ngIf="subordinate.identifier === 'legalNote'">
      <p>{{ subordinate.legal }}</p>
    </ng-container>

    <!-- block -->
    <ng-container *ngIf="subordinate.identifier === 'block' && displayTitle">
      <h5 class="pt-4 pb-2">{{ subordinate.title }}</h5>
    </ng-container>

    <!-- variableBlock-->
    <ng-container *ngIf="subordinate.identifier === 'variableBlock'">
      <h6 class="pt-4 pb-2">{{ subordinate.title }}</h6>
    </ng-container>

    <!-- variableLine -->
    <ng-container *ngIf="subordinate.identifier === 'variableLine'">
      <div class="flex flex-row justify-between">
        <div class="flex flex-col w-56">
          <div>{{ subordinate.designation }}</div>
        </div>
        <div class="flex flex-col flex-grow">
          <div
            class="flex flex-row flex-grow"
            [ngClass]="subordinate.abbreviation ? 'justify-between' : ''"
          >
            <div *ngIf="subordinate.abbreviation">
              {{ subordinate.abbreviation }}
            </div>
            <div class="flex flex-row">
              <div>{{ subordinate.value }}</div>
              <div>{{ subordinate.unit }}</div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- table -->
    <ng-container *ngIf="subordinate.identifier === 'table'">
      <h6 class="pt-4 pb-2">{{ subordinate.title }}</h6>
      <div class="block overflow-x-auto">
        <table mat-table [dataSource]="subordinate.data.items">
          <ng-container
            *ngFor="let field of subordinate.data.fields; index as i"
          >
            <ng-container [matColumnDef]="'' + field + i">
              <th mat-header-cell *matHeaderCellDef>
                {{ field
                }}<span class="ml-1" *ngIf="subordinate.data.unitFields[i]">{{
                  subordinate.data.unitFields[i].unit
                }}</span>
              </th>
              <td mat-cell *matCellDef="let row">
                <ng-container *ngIf="getItem(row, field) as element">
                  <ng-container *ngIf="element.value; else noValue">
                    {{ element.value }}
                  </ng-container>
                  <ng-template #noValue> - </ng-template>
                </ng-container>
              </td>
            </ng-container>
          </ng-container>
          <tr
            mat-header-row
            *matHeaderRowDef="getHeaders(subordinate.data.fields)"
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: getHeaders(subordinate.data.fields)"
          ></tr>
        </table>
      </div>
      <ng-container *ngIf="subordinate.description">
        <h6 class="pt-4 pb-2">{{ subordinate.description.title }}</h6>
        <ng-container
          [ngTemplateOutlet]="subordinateTemplate"
          [ngTemplateOutletContext]="{ subordinate: subordinate.description }"
        ></ng-container>
      </ng-container>
    </ng-container>

    <!-- greaseResult -->
    <ng-container *ngIf="subordinate.identifier === 'greaseResult'">
      <div *transloco="let t" class="md:w-1/3 inline-flex">
        <div>
          <mat-divider></mat-divider>
          <div class="p-3">
            <a
              class="text-caption text-primary font-medium"
              [attr.href]="
                'https://medias.schaeffler.de/de/search/searchpage?text=' +
                subordinate.greaseResult.title
              "
              target="_blank"
            >
              {{ subordinate.greaseResult.title }} &#10140;
            </a>
            <p class="text-caption">
              {{ subordinate.greaseResult.subtitlePart1 }},
              {{ subordinate.greaseResult.subtitlePart2 }},
              {{ subordinate.greaseResult.subtitlePart3 }}
            </p>
          </div>
          <!-- <pre>{{ subordinate.greaseResult | json }}</pre> -->
          <table mat-table [dataSource]="subordinate.greaseResult.dataSource">
            <ng-container matColumnDef="title">
              <td mat-cell *matCellDef="let element">
                <div class="flex gap-1 content-center">
                  <span class="text-caption text-left">
                    {{ t(element.title) || element.title }}
                  </span>
                  <div class="flex items-end">
                    <mat-icon
                      *ngIf="element.tooltip"
                      class="!text-[16px] !w-4 !h-4"
                      color="primary"
                      #tooltip="matTooltip"
                      [matTooltip]="t(element.tooltip)"
                      >info_outline</mat-icon
                    >
                  </div>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="values">
              <td mat-cell *matCellDef="let element">
                <p class="text-center">
                  {{ element.values }}
                </p>
              </td>
            </ng-container>

            <tr
              mat-row
              *matRowDef="
                let row;
                columns: subordinate.greaseResult.displayedColumns
              "
            ></tr>
          </table>
          <div class="p-3">
            <a
              class="text-caption text-primary font-medium cursor-pointer"
              (click)="toggleShowValues(subordinate)"
            >
              {{
                t(
                  !subordinate.greaseResult.showValues
                    ? 'allValues'
                    : 'hideValues'
                )
              }}
            </a>
          </div>
          <mat-divider class="relative-divider"></mat-divider>
          <div class="p-3">
            <span>{{ t('guideValues') }}</span>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- recursive nested subordinates -->
    <ng-container *ngIf="subordinate.subordinates">
      <ng-container *ngFor="let nestedSubordinate of subordinate.subordinates">
        <ng-container
          [ngTemplateOutlet]="subordinateTemplate"
          [ngTemplateOutletContext]="{
            subordinate: nestedSubordinate,
            displayTitle: true
          }"
        >
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-template>
</div>
